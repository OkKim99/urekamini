<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <title>프로필 요청 관리</title>
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <style>
        html, body {
            height: 100%; /* 전체 높이 설정 */
            margin: 0; /* 기본 마진 제거 */
            margin-left: 100px; /* 자동으로 마진 설정 */
            display: flex; /* Flexbox 사용 */
            flex-direction: column; /* 세로 방향으로 배치 */
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
        }

        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 1000px; /* 최대 너비 설정 */
            flex: 1; /* Flexbox로 공간 차지 */
            display: flex; /* 내부 요소들을 중앙 정렬 */
            flex-direction: column; /* 세로 방향으로 배치 */
            align-items: center; /* 수직 중앙 정렬 */
            justify-content: flex-start; /* 수직 위쪽 정렬 */
            padding: 20px;
            margin-left: auto; /* 자동으로 마진 설정 */
            margin-right: auto; /* 자동으로 마진 설정 */
            margin-top: 100px; /* navbar 높이에 따라 조정 */
            margin-bottom: 20px; /* navbar 높이에 따라 조정 */
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px; /* 제목과 요청 목록 사이의 간격 */
        }

        .board {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px; /* 카드 간격 */
            width: 100%; /* 전체 너비 설정 */
        }

        .request-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .request-card span {
            margin-bottom: 10px;
            font-weight: bold;
        }

        .btn-custom {
            height: 45px;
            padding: 0 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .btn-approved {
            background-color: #007bff; /* 파란색 */
            color: white;
        }

        .btn-rejected {
            background-color: gray; /* 회색 */
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center; /* 중앙 정렬 */
            align-items: center; /* 수직 중앙 정렬 */
            margin-top: 20px; /* 카드와 버튼 간격 */
            width: 100%; /* 버튼의 너비 설정 */
            padding-bottom: 70px;
        }

        .pagination button {
            margin: 0 15px; /* 버튼 간격 설정 */
            padding: 10px 20px; /* 버튼 패딩 추가 */
            font-size: 16px; /* 버튼 글자 크기 조정 */
        }
    </style>
</head>
<body>
<header>
    <!-- Navbar HTML이 동적으로 로드됨 -->
</header>

<div class="container" id="requestList">
    <h1>프로필 요청</h1> <!-- 제목 추가 -->
</div>
<div class="pagination" id="pagination">
    <button id="prevPage" class="btn btn-primary" disabled>이전</button>
    <button id="nextPage" class="btn btn-primary">다음</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script type="module" src="/js/auth.js"></script>
<script src="/js/navbar.js"></script>
<script>
    let currentPage = 0; // 현재 페이지 번호
    const pageSize = 9; // 페이지당 요청 수

    async function fetchRequests() {
        try {
            const response = await fetch(`http://localhost:8080/api/profiles?page=${currentPage}&size=${pageSize}`);
            const data = await response.json();

            const requestList = document.getElementById('requestList');
            requestList.innerHTML = '<h1 style="font-weight: bold;">프로필 요청</h1>'; // 제목 초기화

            const board = document.createElement('div');
            board.className = 'board';

            // 요청을 'PENDING' 상태와 그 외로 분리하여 정렬
            const pendingRequests = data.response.content.filter(item => item.requestStatus === 'PENDING');
            const otherRequests = data.response.content.filter(item => item.requestStatus !== 'PENDING');

            // 'PENDING' 요청 먼저 추가
            pendingRequests.forEach(item => {
                const requestCard = createRequestCard(item, true);
                board.appendChild(requestCard);
            });

            // 나머지 요청 추가
            otherRequests.forEach(item => {
                const requestCard = createRequestCard(item, false);
                board.appendChild(requestCard);
            });

            requestList.appendChild(board); // 보드에 요청 카드 추가

            // 페이지 버튼 상태 업데이트
            updatePaginationButtons(data.response.totalPages);
        } catch (error) {
            console.error('요청 가져오기 오류:', error);
        }
    }

    function createRequestCard(item, isPending) {
        const requestCard = document.createElement('div');
        requestCard.className = 'request-card';
        requestCard.innerHTML =
            `<span>사용자: ${item.user}</span>
            <span>프로필: ${item.profile}</span>
            <span>상태: ${item.requestStatus}</span>
            <div>
                ${isPending ?
                `<button class="btn btn-custom btn-approved" onclick="updateRequest(${item.id}, 'APPROVED')">승인</button>
                     <button class="btn btn-custom btn-rejected" onclick="updateRequest(${item.id}, 'REJECTED')">거부</button>`
                :
                `<button class="btn btn-primary disabled" disabled>처리 완료</button>`
            }
            </div>`;
        return requestCard;
    }

    async function updateRequest(requestId, status) {
        try {
            const response = await fetch(`http://localhost:8080/api/profiles/${requestId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ requestStatus: status }),
            });

            if (response.ok) {
                alert(`요청이 ${status}로 업데이트되었습니다.`);
                fetchRequests(); // 요청 리스트 새로 고침
            } else {
                alert('요청 업데이트에 실패했습니다.');
            }
        } catch (error) {
            console.error('업데이트 오류:', error);
        }
    }

    function updatePaginationButtons(totalPages) {
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');

        prevButton.disabled = currentPage === 0;
        nextButton.disabled = currentPage >= totalPages - 1;
    }

    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            fetchRequests();
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        currentPage++;
        fetchRequests();
    });

    window.onload = fetchRequests; // 페이지 로드 시 요청 가져오기
</script>
</body>
</html>
