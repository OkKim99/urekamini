<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board</title>
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <style>
        .table th, .table td {
            vertical-align: middle;
        }
        .btn-custom {
            background-color: #ff007f;
            color: white;
            height: 45px;
            padding: 0 15px;
            border: none;
        }
    </style>
</head>
<body>

<!-- Navbar Include -->
<header>
    <!-- Include navbar.html here -->
</header>

<div class="container" style="margin-left: 250px; padding-top: 20px;">
    <!-- 글쓰기 버튼 -->
    <div class="d-flex justify-content-end mb-4">
        <button class="btn btn-custom" data-bs-toggle="modal" data-bs-target="#writeModal">글쓰기</button>
    </div>

    <!-- 게시물 테이블 -->
    <table class="table table-hover">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">제목</th>
            <th scope="col">작성자</th>
            <th scope="col">취미</th>
            <th scope="col">따봉수</th>
        </tr>
        </thead>
        <tbody id="board-posts">
        <!-- 게시물 목록이 여기에 추가됩니다 -->
        </tbody>
    </table>

    <!-- 페이지네이션 -->
    <div class="d-flex justify-content-center">
        <ul class="pagination" id="pagination">
            <!-- 페이지 버튼들이 여기에 추가됩니다 -->
        </ul>
    </div>
</div>

<!-- 글쓰기 모달 -->
<div class="modal fade" id="writeModal" tabindex="-1" aria-labelledby="writeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #ff007f;">
                <h5 class="modal-title text-white" id="writeModalLabel">글쓰기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="writeForm">
                    <div class="mb-3">
                        <label for="postTitle" class="form-label">제목</label>
                        <input type="text" class="form-control" id="postTitle" placeholder="제목을 입력하세요" required>
                    </div>
                    <div class="mb-3">
                        <label for="postContent" class="form-label">내용</label>
                        <textarea class="form-control" id="postContent" rows="5" placeholder="내용을 입력하세요" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="postCategory" class="form-label">취미 카테고리</label>
                        <select class="form-select" id="postCategory" required>
                            <option value="" disabled selected>취미 카테고리를 선택하세요</option>
                            <option value="CULTURAL_LIFE">문화생활</option>
                            <option value="EXERCISE">운동</option>
                            <option value="FOOD">음식</option>
                            <option value="GAME">게임</option>
                            <option value="MUSIC">음악</option>
                            <option value="TRAVEL">여행</option>
                            <option value="ETC">기타</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="postVideoLink" class="form-label">비디오 링크</label>
                        <input type="text" class="form-control" id="postVideoLink" placeholder="비디오 링크를 입력하세요">
                        <div class="invalid-feedback">유효한 유튜브 링크를 입력하세요.</div>
                    </div>
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script type="module" src="/js/auth.js"></script>
<script src="/js/navbar.js"></script>
<script>
    let currentPage = 0;
    let totalPages = 0;
    const pageSize = 10;

    document.addEventListener('DOMContentLoaded', function () {
        fetchPosts(currentPage, pageSize);

        document.getElementById('writeForm').addEventListener('submit', function (e) {
            e.preventDefault();
            if (validateVideoLink()) {
                savePost();
            }
        });
    });

    function fetchPosts(page, size) {
        fetch(`/api/posts?page=${page}&size=${size}`)
            .then(response => response.json())
            .then(data => {
                renderPostTable(data.response.content, page);
                currentPage = data.response.number;
                totalPages = data.response.totalPages;
                renderPagination(); // 페이지네이션 버튼을 새로 고침
            });
    }

    function renderPostTable(posts, page) {
        const postTable = document.getElementById('board-posts');
        postTable.innerHTML = '';
        posts.forEach((post, index) => {
            const row = `
                <tr>
                    <th scope="row">${index + 1 + page * pageSize}</th>
                    <td><a href="detail.html?postId=${post.id}">${post.title}</a></td>
                    <td>${post.name}</td>
                    <td>${post.hobbyCategory}</td> <!-- 취미 표시 -->
                    <td>${post.thumbsUp}</td>
                </tr>
            `;
            postTable.innerHTML += row;
        });
    }

    function renderPagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (totalPages > 1) {
            if (currentPage > 0) {
                pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">이전</a></li>`;
            }

            for (let i = 0; i < totalPages; i++) {
                pagination.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i + 1}</a></li>`;
            }

            if (currentPage < totalPages - 1) {
                pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">다음</a></li>`;
            }
        }
    }

    function changePage(page) {
        fetchPosts(page, pageSize);
    }

    function savePost() {
        const title = document.getElementById('postTitle').value;
        const description = document.getElementById('postContent').value;
        const hobbyCategory = document.getElementById('postCategory').value;
        const videoLink = document.getElementById('postVideoLink').value;

        const token = localStorage.getItem("accessToken");
        if (!token) {
            console.error("토큰이 없습니다.");
            return;
        }

        fetch('/api/posts', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, description, hobbyCategory, videoLink })
        })
            .then(response => response.json())
            .then(data => {
                alert('글이 저장되었습니다.');
                document.querySelector('[data-bs-dismiss="modal"]').click(); // 모달 닫기
                fetchPosts(currentPage,pageSize); // 게시물 목록 새로 고침
            });
    }

    function validateVideoLink() {
        const videoLink = document.getElementById('postVideoLink').value;
        const youtubePattern = /^(https:\/\/www\.youtube\.com\/watch\?v=[\w-]{11}|https:\/\/youtu\.be\/[\w-]{11})(\?si=[\w-]+)?$/;
        const isValid = youtubePattern.test(videoLink);

        if (!isValid) {
            document.getElementById('postVideoLink').classList.add('is-invalid');
            return false;
        } else {
            document.getElementById('postVideoLink').classList.remove('is-invalid');
            return true;
        }
    }

</script>

</body>
</html>
