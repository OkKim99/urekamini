<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U+ Home Page</title>
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/map.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body>

<header>
    <!-- Navbar HTML이 동적으로 로드됨 -->
</header>

<div class="container">
    <h1 class="text-center">지도 페이지</h1>
    <p class="text-center">다음은 사용자들의 위치를 표시한 지도입니다.</p>
    <div class="map-container" id="map"></div>
</div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b725e40e2b697b42e1aac0b02c8a06ee&libraries=clusterer"></script>
<script>
    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng(36.84, 127.77),
            level: 13
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);

    var markers = [];

    fetch('/api/profiles')
        .then(response => response.json())
        .then(data => {
            console.log("데이터를 가져왔습니다.", data);

            data.forEach(profile => {
                if (profile.region && profile.region.latitude && profile.region.longitude && profile.user && profile.user.name) {
                    var position = new kakao.maps.LatLng(profile.region.latitude, profile.region.longitude);

                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: position,
                        title: profile.user.name
                    });

                    markers.push(marker);

                    var infowindow = new kakao.maps.InfoWindow({
                        content: `<div style="padding: 3px 5px; background-color: #fff; border-radius: 6px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); font-size: 12px; color: #333; width: 150px; height: auto; display: flex; flex-direction: column; align-items: center; text-align: center; font-family: 'Arial', sans-serif;">
                            <!-- 이름을 클릭 시 디테일 페이지로 이동 -->
                            <a href="detail.html?userId=${profile.user.id}" style="text-decoration: none; color: #333;">
                                <strong style="font-size: 14px; font-weight: bold;">${profile.user.name}</strong>
                            </a>
                            <span style="margin-top: 2px; font-size: 12px; color: #666;">${profile.region.name || '주소 정보 없음'}</span>
                        </div>`
                    });

                    kakao.maps.event.addListener(marker, 'click', function() {
                        if (infowindow.getMap()) {
                            infowindow.close();
                        } else {
                            infowindow.open(map, marker);
                        }
                    });
                } else {
                    console.error('Profile 데이터가 부족합니다:', profile);
                }
            });
        })
        .catch(error => {
            console.error('지도를 업데이트하는 중 오류 발생:', error);
        });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/navbar.js"></script>
</body>
</html>
